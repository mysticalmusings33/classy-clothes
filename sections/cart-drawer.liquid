<!-- 
  Sliding cart drawer that opens from right side
-->

<style>
  /* ==================== CART DRAWER OVERLAY ==================== */
  
  .cart-drawer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    z-index: 998;
  }
  
  .cart-drawer-overlay.active {
    opacity: 1;
    visibility: visible;
  }
  
  /* ==================== CART DRAWER ==================== */
  
  .cart-drawer {
    position: fixed;
    top: 0;
    right: 0;
    width: 450px;
    max-width: 90vw;
    height: 100%;
    background: var(--color-white);
    transform: translateX(100%);  /* Starts off-screen to right */
    transition: transform 0.3s ease;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
  }
  
  .cart-drawer.active {
    transform: translateX(0);  /* Slides into view */
  }
  
  /* ==================== DRAWER HEADER ==================== */
  
  .cart-drawer-header {
    padding: var(--spacing-sm);
    border-bottom: 1px solid var(--color-light-gray);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-shrink: 0;
  }
  
  .cart-drawer-title {
    font-family: var(--font-heading);
    font-size: 1.5rem;
    margin: 0;
  }
  
  .cart-drawer-close {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    color: var(--color-primary);
    transition: var(--transition);
  }
  
  .cart-drawer-close:hover {
    color: var(--color-secondary);
  }
  
  .cart-drawer-close svg {
    width: 24px;
    height: 24px;
    stroke: currentColor;
    stroke-width: 2;
  }
  
  /* ==================== DRAWER BODY (Scrollable) ==================== */
  
  .cart-drawer-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--spacing-md);
  }
  
  /* Empty state */
  .cart-drawer-empty {
    text-align: center;
    padding: var(--spacing-xl) var(--spacing-md);
  }
  
  .cart-drawer-empty h3 {
    font-size: 1.25rem;
    margin-bottom: var(--spacing-sm);
    color: var(--color-primary);
  }
  
  .cart-drawer-empty p {
    color: #666;
    margin-bottom: var(--spacing-md);
  }
  
  /* Cart items */
  .cart-drawer-items {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
  }
  
  .cart-item {
    display: grid;
    grid-template-columns: 80px 1fr auto;
    gap: var(--spacing-sm);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--color-light-gray);
  }
  
  .cart-item:last-child {
    border-bottom: none;
  }
  
  /* Cart item image */
  .cart-item-image {
    width: 80px;
    height: 100px;
    object-fit: cover;
    background: var(--color-light-gray);
  }
  
  /* Cart item details */
  .cart-item-details {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }
  
  .cart-item-title {
    font-family: var(--font-heading);
    font-size: 1rem;
    margin: 0;
    color: var(--color-primary);
  }
  
  .cart-item-vendor {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #999;
  }
  
  .cart-item-variant {
    font-size: 0.875rem;
    color: #666;
  }
  
  .cart-item-price {
    font-size: 0.875rem;
    color: var(--color-primary);
    margin-top: 0.25rem;
  }
  
  /* Quantity controls */
  .cart-item-quantity {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }
  
  .quantity-btn-small {
    width: 28px;
    height: 28px;
    border: 1px solid var(--color-light-gray);
    background: var(--color-white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: var(--color-primary);
    transition: var(--transition);
  }
  
  .quantity-btn-small:hover {
    border-color: var(--color-primary);
  }
  
  .quantity-value {
    font-size: 0.875rem;
    min-width: 20px;
    text-align: center;
  }
  
  /* Remove button */
  .cart-item-remove {
    align-self: start;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    color: #999;
    transition: var(--transition);
  }
  
  .cart-item-remove:hover {
    color: var(--color-primary);
  }
  
  .cart-item-remove svg {
    width: 20px;
    height: 20px;
    stroke: currentColor;
    stroke-width: 2;
  }
  
  /* ==================== DRAWER FOOTER ==================== */
  
  .cart-drawer-footer {
    padding: var(--spacing-sm) var(--spacing-md);  /* Reduced vertical padding */
    border-top: 1px solid var(--color-light-gray);
    flex-shrink: 0;
  }
  
  .cart-drawer-subtotal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);  /* Reduced from --spacing-md */
    font-size: 1rem;  /* Slightly smaller */
  }
  
  .cart-drawer-subtotal-label {
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-primary);
    font-size: 0.875rem;  /* Slightly smaller */
  }
  
  .cart-drawer-subtotal-value {
    font-family: var(--font-heading);
    font-size: 1.25rem;  /* Reduced from 1.5rem */
    color: var(--color-primary);
  }
  
  .cart-drawer-note {
    font-size: 0.7rem;  /* Slightly smaller */
    color: #999;
    text-align: center;
    margin-bottom: var(--spacing-sm);  /* Reduced from --spacing-md */
  }
  
  .cart-drawer-checkout {
    width: 100%;
    padding: 1rem;  /* Reduced from 1.25rem */
    font-family: var(--font-body);
    font-size: 0.8125rem;  /* Slightly smaller */
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border: none;
    background: var(--color-primary);
    color: var(--color-white);
    cursor: pointer;
    transition: var(--transition);
    margin-bottom: 0.5rem;  /* Reduced spacing */
  }
  
  .cart-drawer-checkout:hover {
    background: var(--color-secondary);
  }
  
  .cart-drawer-view-cart {
    width: 100%;
    padding: 0.75rem;  /* Reduced from 1rem */
    font-size: 0.8125rem;  /* Slightly smaller */
    text-transform: uppercase;
    letter-spacing: 0.1em;
    border: 1px solid var(--color-primary);
    background: transparent;
    color: var(--color-primary);
    cursor: pointer;
    transition: var(--transition);
    text-align: center;
    display: block;
    text-decoration: none;
  }
  
  .cart-drawer-view-cart:hover {
    background: var(--color-light-gray);
  }
  
  /* ==================== LOADING STATE ==================== */
  
  .cart-drawer-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10;
  }
  
  .cart-drawer-loading.active {
    display: flex;
  }
  
  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-light-gray);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* ==================== RESPONSIVE ==================== */
  
  @media (max-width: 768px) {
    .cart-drawer {
      width: 100%;
      max-width: 100%;
    }
    
    .cart-item {
      grid-template-columns: 60px 1fr auto;
    }
    
    .cart-item-image {
      width: 60px;
      height: 75px;
    }
  }
</style>
  
<!-- ==================== CART DRAWER HTML ==================== -->

<!-- Overlay (clicking closes drawer) -->
<div class="cart-drawer-overlay" id="cart-drawer-overlay" onclick="closeCartDrawer()"></div>

<!-- Drawer -->
<div class="cart-drawer" id="cart-drawer">
  
  <!-- Header -->
  <div class="cart-drawer-header">
    <h2 class="cart-drawer-title">Your Cart (<span id="cart-drawer-count">0</span>)</h2>
    <button class="cart-drawer-close" onclick="closeCartDrawer()" aria-label="Close cart">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    </button>
  </div>
  
  <!-- Body (scrollable) -->
  <div class="cart-drawer-body" id="cart-drawer-body">
    <!-- Content populated by JavaScript -->
  </div>
  
  <!-- Footer -->
  <div class="cart-drawer-footer" id="cart-drawer-footer" style="display: none;">
    <div class="cart-drawer-subtotal">
      <span class="cart-drawer-subtotal-label">Subtotal</span>
      <span class="cart-drawer-subtotal-value" id="cart-drawer-subtotal">$0.00</span>
    </div>
    
    <p class="cart-drawer-note">Shipping and taxes calculated at checkout</p>
    
    <button class="cart-drawer-checkout" onclick="window.location.href='/checkout'">
      Proceed to Checkout
    </button>
    
    <a href="/cart" class="cart-drawer-view-cart">View Cart</a>
  </div>
  
  <!-- Loading overlay -->
  <div class="cart-drawer-loading" id="cart-drawer-loading">
    <div class="loading-spinner"></div>
  </div>
  
</div>

<!-- ==================== JAVASCRIPT ==================== -->
<script>
  /**
    * Open cart drawer
    */
  function openCartDrawer() {
    document.getElementById('cart-drawer').classList.add('active');
    document.getElementById('cart-drawer-overlay').classList.add('active');
    document.body.style.overflow = 'hidden';  // Prevent body scrolling
    
    // Refresh cart contents when opening
    refreshCartDrawer();
  }
  
  /**
    * Close cart drawer
    */
  function closeCartDrawer() {
    document.getElementById('cart-drawer').classList.remove('active');
    document.getElementById('cart-drawer-overlay').classList.remove('active');
    document.body.style.overflow = '';  // Re-enable body scrolling
  }
  
  /**
    * Fetch current cart and update drawer UI
    */
  async function refreshCartDrawer() {
    showLoading(true);
    
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();
      
      // Update cart count
      document.getElementById('cart-drawer-count').textContent = cart.item_count;
      
      // Update body content
      const bodyElement = document.getElementById('cart-drawer-body');
      
      if (cart.item_count === 0) {
        // Empty cart state
        bodyElement.innerHTML = `
          <div class="cart-drawer-empty">
            <h3>Your cart is empty</h3>
            <p>Add some items to get started</p>
            <button class="btn" onclick="closeCartDrawer()">Continue Shopping</button>
          </div>
        `;
        document.getElementById('cart-drawer-footer').style.display = 'none';
      } else {
        // Populate cart items
        bodyElement.innerHTML = `
          <div class="cart-drawer-items">
            ${cart.items.map((item, index) => renderCartItem(item, index + 1)).join('')}
          </div>
        `;
        
        // Update subtotal
        document.getElementById('cart-drawer-subtotal').textContent = formatMoney(cart.total_price);
        document.getElementById('cart-drawer-footer').style.display = 'block';
      }
      
      // Update header cart count badge (if exists)
      updateHeaderCartCount(cart.item_count);
      
    } catch (error) {
      console.error('Error fetching cart:', error);
    } finally {
      showLoading(false);
    }
  }
  
  /**
    * Render a single cart item
    */
  function renderCartItem(item, lineNumber) {
    return `
      <div class="cart-item" data-line="${lineNumber}">
        <img src="${item.featured_image?.url || item.image}" 
              alt="${item.title}" 
              class="cart-item-image">
        
        <div class="cart-item-details">
          ${item.vendor ? `<div class="cart-item-vendor">${item.vendor}</div>` : ''}
          <h3 class="cart-item-title">${item.product_title}</h3>
          ${item.variant_title ? `<div class="cart-item-variant">${item.variant_title}</div>` : ''}
          <div class="cart-item-price">${formatMoney(item.final_line_price)}</div>
          
          <div class="cart-item-quantity">
            <button class="quantity-btn-small" onclick="updateQuantity(${lineNumber}, ${item.quantity - 1})" ${item.quantity <= 1 ? 'disabled' : ''}>
              âˆ’
            </button>
            <span class="quantity-value">${item.quantity}</span>
            <button class="quantity-btn-small" onclick="updateQuantity(${lineNumber}, ${item.quantity + 1})">
              +
            </button>
          </div>
        </div>
        
        <button class="cart-item-remove" onclick="removeItem(${lineNumber})" aria-label="Remove item">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
    `;
  }
  
  /**
    * Update item quantity
    */
  async function updateQuantity(lineNumber, newQuantity) {
    if (newQuantity < 0) return;
    
    showLoading(true);
    
    try {
      const response = await fetch('/cart/change.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          line: lineNumber,
          quantity: newQuantity
        })
      });
      
      if (response.ok) {
        refreshCartDrawer();
      }
    } catch (error) {
      console.error('Error updating quantity:', error);
      alert('Could not update quantity');
    } finally {
      showLoading(false);
    }
  }
  
  /**
    * Remove item from cart
    */
  async function removeItem(lineNumber) {
    showLoading(true);
    
    try {
      const response = await fetch('/cart/change.js', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          line: lineNumber,
          quantity: 0
        })
      });
      
      if (response.ok) {
        refreshCartDrawer();
      }
    } catch (error) {
      console.error('Error removing item:', error);
      alert('Could not remove item');
    } finally {
      showLoading(false);
    }
  }
  
  /**
    * Format money (cents to dollars)
    */
  function formatMoney(cents) {
    return '$' + (cents / 100).toFixed(2);
  }
  
  /**
    * Show/hide loading spinner
    */
  function showLoading(show) {
    const loader = document.getElementById('cart-drawer-loading');
    if (show) {
      loader.classList.add('active');
    } else {
      loader.classList.remove('active');
    }
  }
  
  /**
    * Update header cart count badge
    */
  function updateHeaderCartCount(count) {
    const cartCountElement = document.querySelector('.cart-count');
    if (cartCountElement) {
      cartCountElement.textContent = count;
      cartCountElement.style.display = count > 0 ? 'flex' : 'none';
    }
  }
  
  /**
    * GLOBAL: Make cart drawer open when cart icon is clicked
    * This function should be called from your header
    */
  window.openCartDrawer = openCartDrawer;
  
  /**
    * GLOBAL: Open cart drawer after adding item
    * Call this after successful add to cart
    */
  window.openCartDrawerAfterAdd = function() {
    openCartDrawer();
  };
  
  // Initialize: update cart count on page load
  document.addEventListener('DOMContentLoaded', async function() {
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();
      updateHeaderCartCount(cart.item_count);
    } catch (error) {
      console.error('Error initializing cart:', error);
    }
  });
</script>

<!-- ==================== SCHEMA ==================== -->
{% schema %}
{
  "name": "Cart Drawer",
  "settings": []
}
{% endschema %}